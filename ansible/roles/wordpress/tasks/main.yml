---
- name: Add PHP PPA
  apt_repository:
    repo: 'ppa:ondrej/php'
    state: present
    update_cache: yes

- name: Install Nginx, PHP, MariaDB, Certbot
  apt:
    name:
      - nginx
      - php8.3-fpm
      - php8.3-mysql
      - php8.3-xml
      - php8.3-curl
      - php8.3-mbstring
      - php8.3-zip
      - php8.3-gd
      - mariadb-server
      - certbot
      - python3-certbot-nginx
    state: present

- name: Install WP-CLI
  get_url:
    url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    dest: /usr/local/bin/wp
    mode: '0755'

- name: Create Web Root
  file:
    path: /var/www/{{ domain }}
    state: directory
    owner: www-data
    group: www-data
    mode: '0775'

# Database Setup
- name: Create MariaDB Database
  community.mysql.mysql_db:
    name: "{{ wp_db_name }}"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock # Use socket for local root

- name: Create MariaDB User
  community.mysql.mysql_user:
    name: "{{ wp_db_user }}"
    password: "{{ wp_db_pass }}"
    priv: "{{ wp_db_name }}.*:ALL"
    host: localhost
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock

# WordPress Setup
- name: Check if WP is installed
  stat:
    path: /var/www/{{ domain }}/wp-config.php
  register: wp_config_check

- name: Download WordPress
  become_user: www-data
  shell: wp core download --path=/var/www/{{ domain }}
  when: not wp_config_check.stat.exists

- name: Configure WordPress
  become_user: www-data
  shell: |
    wp config create \
    --dbname={{ wp_db_name }} \
    --dbuser={{ wp_db_user }} \
    --dbpass={{ wp_db_pass }} \
    --path=/var/www/{{ domain }}
  when: not wp_config_check.stat.exists

- name: Install WordPress
  become_user: www-data
  shell: |
    wp core install \
    --url=http://{{ domain }} \
    --title="{{ domain }}" \
    --admin_user={{ wp_admin_user }} \
    --admin_password={{ wp_admin_pass }} \
    --admin_email={{ admin_email }} \
    --path=/var/www/{{ domain }} \
    --skip-email
  when: not wp_config_check.stat.exists
  ignore_errors: yes # Might fail if already installed but config missing (unlikely)

# Nginx Configuration (Placeholder)
- name: Configure Nginx (Simplistic Example)
  copy:
    dest: /etc/nginx/sites-available/{{ domain }}
    content: |
      server {
          listen 80;
          server_name {{ domain }} www.{{ domain }};
          root /var/www/{{ domain }};
          index index.php index.html;
          location / {
              try_files $uri $uri/ /index.php?$args;
          }
          location ~ \.php$ {
              include snippets/fastcgi-php.conf;
              fastcgi_pass unix:/run/php/php8.3-fpm.sock;
          }
      }
  notify: Restart Nginx

- name: Enable Nginx Site
  file:
    src: /etc/nginx/sites-available/{{ domain }}
    dest: /etc/nginx/sites-enabled/{{ domain }}
    state: link
  notify: Restart Nginx

- name: Remove Default Nginx Site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Restart Nginx

# SSL via Certbot (requires valid DNS and enable_ssl: true)
- name: Run Certbot to obtain SSL certificate
  command: >
    certbot --nginx -d {{ domain }}{% if use_www %} -d www.{{ domain }}{% endif %}
    --non-interactive --agree-tos -m {{ admin_email }} --redirect
  when: enable_ssl | default(false)

